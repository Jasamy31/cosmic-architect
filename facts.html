<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fact-Check with Gemini</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">
    <div class="container mx-auto p-6 bg-white rounded-xl shadow-lg flex flex-col items-center">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-6 text-center">Fact-Check with Gemini</h1>
        <p class="text-gray-600 mb-6 text-center">
            Enter a statement or claim below and I will use Google Search to find information to help you verify it.
        </p>

        <!-- Message box for user feedback -->
        <div id="message-box" class="w-full bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4 hidden" role="alert">
            <span class="block sm:inline" id="message-text"></span>
        </div>

        <textarea id="claim-input"
                  class="w-full h-32 p-4 mb-4 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all resize-none"
                  placeholder="e.g., 'The first person to walk on the moon was Neil Armstrong.'"
                  aria-label="Enter a claim to fact-check"></textarea>

        <button id="check-button"
                class="w-full sm:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-full shadow-md hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-colors transform hover:scale-105 active:scale-95">
            Check Fact
        </button>

        <!-- Loading spinner and message -->
        <div id="loading-indicator" class="mt-8 text-blue-600 hidden">
            <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-sm text-gray-500">Fact-checking, please wait...</p>
        </div>

        <!-- Results display area -->
        <div id="results-container" class="w-full mt-8 hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-2">Analysis:</h2>
            <div id="result-content" class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <!-- Fact-check result will be injected here -->
            </div>

            <h3 class="text-lg font-bold text-gray-800 mt-6 mb-2">Sources:</h3>
            <ul id="sources-list" class="space-y-2 text-sm text-gray-600">
                <!-- Sources will be injected here -->
            </ul>
        </div>
    </div>

    <script>
        const claimInput = document.getElementById('claim-input');
        const checkButton = document.getElementById('check-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const resultsContainer = document.getElementById('results-container');
        const resultContent = document.getElementById('result-content');
        const sourcesList = document.getElementById('sources-list');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');

        function showMessage(message) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        checkButton.addEventListener('click', async () => {
            const userQuery = claimInput.value.trim();
            if (!userQuery) {
                showMessage('Please enter a statement to check.');
                return;
            }

            // Clear previous results and messages
            messageBox.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            resultsContainer.classList.add('hidden');
            resultContent.innerHTML = '';
            sourcesList.innerHTML = '';

            const systemPrompt = "You are a neutral fact-checker. You will be given a statement. Your task is to provide a concise, single-paragraph analysis of the statement's accuracy, based on information found on the web. Cite your sources clearly at the end of the analysis.";

            const apiKey = "AIzaSyBzyZo3Y521Rb6yXXWmnJIHW6lT53AX-6I"; // Canvas will provide this at runtime
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            const maxRetries = 3;
            let retries = 0;
            let success = false;

            while (retries < maxRetries && !success) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429) {
                            console.warn(`Attempt ${retries + 1}: Rate limit hit. Retrying in ${Math.pow(2, retries)} seconds...`);
                            await new Promise(resolve => setTimeout(resolve, Math.pow(2, retries) * 1000));
                            retries++;
                            continue;
                        } else {
                            throw new Error(`API error: ${response.statusText}`);
                        }
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        const groundingMetadata = candidate.groundingMetadata;

                        resultContent.textContent = text;
                        resultsContainer.classList.remove('hidden');

                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            const sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);

                            if (sources.length > 0) {
                                sources.forEach(source => {
                                    const li = document.createElement('li');
                                    const a = document.createElement('a');
                                    a.href = source.uri;
                                    a.textContent = source.title;
                                    a.target = "_blank";
                                    a.className = "text-blue-500 hover:underline";
                                    li.appendChild(a);
                                    sourcesList.appendChild(li);
                                });
                            } else {
                                const li = document.createElement('li');
                                li.textContent = 'No sources were found for this claim. This may happen for common facts or if the model already has high confidence in the information.';
                                sourcesList.appendChild(li);
                            }
                        } else {
                            const li = document.createElement('li');
                            li.textContent = 'No sources were found for this claim. This may happen for common facts or if the model already has high confidence in the information.';
                            sourcesList.appendChild(li);
                        }
                        success = true;
                    } else {
                        resultContent.textContent = 'Could not get a valid response from the API. Please try again.';
                        resultsContainer.classList.remove('hidden');
                        success = true;
                    }
                } catch (error) {
                    resultContent.textContent = `An error occurred: ${error.message}`;
                    resultsContainer.classList.remove('hidden');
                    console.error('API call failed:', error);
                    success = true;
                } finally {
                    loadingIndicator.classList.add('hidden');
                }
            }
        });
    </script>
</body>
</html>

